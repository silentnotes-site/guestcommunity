<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Guest Community</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{width:100%;height:100%;font-family:'Outfit',sans-serif;background:linear-gradient(to right,#0f0c29,#302b63,#24243e);overflow:hidden;color:#fff}
    #ring-intro{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0f0c29;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:9999}
    #ring-text{font-size:6rem;font-weight:700;letter-spacing:.3em;color:#25d366;text-shadow:0 0 20px #25d366cc;opacity:0}
    #ring-subtext{margin-top:1rem;font-size:1.4rem;color:#aaa;opacity:0}
    #main-site{display:none;position:relative;z-index:2;height:100vh;overflow-y:auto;padding-bottom:60px}
    header{position:sticky;top:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(6px);padding:1rem 3rem;display:flex;justify-content:space-between;align-items:center;z-index:10}
    header h1{font-size:1.8rem;user-select:none}
    nav{display:flex;gap:1.5rem;flex-wrap:wrap}
    nav a{color:#ccc;font-weight:600;cursor:pointer;text-decoration:none;padding-bottom:4px;border-bottom:2px solid transparent;transition:color .3s,border-color .3s}
    nav a:hover,nav a.active{color:#25d366;border-bottom-color:#25d366}
    main{max-width:900px;margin:80px auto 40px;padding:0 20px}
    section{display:none}
    section.active{display:block}
    h2{margin-bottom:1rem;user-select:none}
    button{background:#25d366;border:none;border-radius:30px;padding:1rem 2rem;font-size:1.2rem;color:#fff;cursor:pointer;box-shadow:0 6px 15px #25d366aa;margin-top:1.5rem;user-select:none;transition:background .3s}
    button:hover{background:#1da851}
    input,textarea{width:100%;padding:.8rem 1rem;border-radius:10px;border:none;font-size:1rem;resize:vertical;margin-bottom:1rem}
    input#news-search{padding:.5rem 1rem;font-size:1rem;border-radius:10px;border:none;margin-bottom:1rem}
    #news-container{display:flex;flex-direction:column;gap:1.5rem}
    .news-item{background:rgba(37,211,102,0.1);border-radius:10px;padding:1rem;display:flex;gap:1rem;color:#ddd}
    .news-image{width:150px;height:100px;border-radius:10px;object-fit:cover;flex-shrink:0;background:#111}
    .news-content{flex:1;display:flex;flex-direction:column}
    .news-title{font-weight:700;font-size:1.1rem;color:#25d366;margin-bottom:.3rem;user-select:none}
    .news-description{font-size:.9rem;margin-bottom:.3rem}
    .news-date{font-size:.8rem;color:#aaa;margin-bottom:.5rem;user-select:none}
    .news-excerpt{font-size:.85rem;color:#ccc;flex-grow:1;user-select:text}
    .news-link{align-self:flex-start;margin-top:.5rem;font-weight:600;color:#25d366;text-decoration:none;user-select:none}
    .news-link:hover{text-decoration:underline}
    #events-list{list-style:none;padding:0}
    .event-item{background:rgba(255,255,255,0.1);border-radius:10px;padding:1rem;margin-bottom:1rem}
    #chatbot-section{padding-top:1rem;}
    #chatbot-messages{background:rgba(37,211,102,0.1);height:300px;overflow-y:auto;border-radius:10px;padding:1rem;display:flex;flex-direction:column;gap:0.7rem;margin-bottom:1rem;color:#ddd;user-select:text;}
    .chat-message{padding:0.5rem 1rem;border-radius:20px;max-width:70%;word-wrap:break-word;}
    .chat-message.user{background:#25d366;color:#000;align-self:flex-end;}
    .chat-message.bot{background:#111;color:#25d366;align-self:flex-start;}
    #chatbot-input{width:100%;padding:.8rem 1rem;border-radius:10px;border:none;font-size:1rem;resize:none;margin-bottom:0.5rem;color:#000;}
    #chatbot-send{background:#25d366;border:none;border-radius:30px;padding:0.8rem 2rem;font-size:1.1rem;color:#fff;cursor:pointer;box-shadow:0 6px 15px #25d366aa;user-select:none;transition:background .3s}
    #chatbot-send:hover{background:#1da851}
    footer{text-align:center;padding:2rem 0;color:#aaa;background:rgba(0,0,0,0.5)}
  </style>
</head>
<body>
<div id="ring-intro">
  <div id="ring-text">Guest Community</div>
  <div id="ring-subtext">Caricamento in corso...</div>
</div>
<div id="main-site" tabindex="0">
  <header>
    <h1>Guest Community</h1>
    <nav>
      <a class="nav-link active" data-section="home">Home</a>
      <a class="nav-link" data-section="meteo">Meteo</a>
      <a class="nav-link" data-section="notizie">Notizie</a>
      <a class="nav-link" data-section="ora">Ora</a>
      <a class="nav-link" data-section="eventi">Eventi</a>
      <a class="nav-link" data-section="chatbot">Chatbot</a>
      <a class="nav-link" data-section="contatti">Contatti</a>
    </nav>
  </header>
  <main>
    <section id="home" class="active">
      <h2>Benvenuto nella Guest Community</h2>
      <p>Unisciti al gruppo WhatsApp per condividere idee, risorse e nuove esperienze.</p>
      <button onclick="window.open('https://chat.whatsapp.com/I9Tw0sIS8ulDD9djqYav36','_blank')">Unisciti al gruppo</button>
    </section>
    <section id="meteo">
      <h2>Meteo</h2>
      <p id="meteo-info">Caricamento meteo...</p>
      <p id="meteo-timezone"></p>
    </section>
    <section id="notizie">
      <h2>Ultime notizie</h2>
      <input id="news-search" placeholder="Cerca notizie..." autocomplete="off"/>
      <p id="news-info">Caricamento notizie...</p>
      <div id="news-container"></div>
    </section>
    <section id="ora">
      <h2>Ora attuale</h2>
      <p id="time-info">Caricamento ora...</p>
      <p id="ora-timezone"></p>
    </section>
    <section id="eventi">
      <h2>Eventi prossimi</h2>
      <ul id="events-list"></ul>
    </section>
    <section id="chatbot">
      <h2>Chatbot Guest Community</h2>
      <div id="chatbot-messages"></div>
      <textarea id="chatbot-input" rows="3" placeholder="Scrivi un messaggio..."></textarea>
      <button id="chatbot-send">Invia</button>
    </section>
    <section id="contatti">
      <h2>Contattaci</h2>
      <form id="contact-form">
        <input type="hidden" name="access_key" value="9a9e0334-0522-4e37-b34d-7f64d72c463f"/>
        <input type="text" name="name" placeholder="Nome completo" required/>
        <input type="email" name="email" placeholder="Email" required/>
        <textarea name="message" placeholder="Messaggio" required></textarea>
        <button type="submit">Invia messaggio</button>
      </form>
    </section>
  </main>
  <footer>© 2025 Guest Community • Powered by Tutuu666k Team</footer>
</div>
<script>
(() => {
  gsap.to('#ring-text',{opacity:1,duration:1});
  gsap.to('#ring-subtext',{opacity:1,duration:1,delay:0.5});
  setTimeout(() => {
    gsap.to(['#ring-text','#ring-subtext'],{opacity:0,duration:1});
    gsap.to('#ring-intro',{opacity:0,duration:1,delay:0.5,onComplete:()=>{
      document.getElementById('ring-intro').remove();
      startApp();
    }});
  },3500);

  function startApp(){
    document.getElementById('main-site').style.display='block';
    gsap.to('#main-site',{opacity:1,duration:1.5});
    const navs=document.querySelectorAll('.nav-link'), secs=document.querySelectorAll('main section');
    navs.forEach(a=>a.addEventListener('click',()=>{
      navs.forEach(x=>x.classList.remove('active'));
      a.classList.add('active');
      secs.forEach(s=>s.id===a.dataset.section?s.style.display='block':s.style.display='none');
      if(a.dataset.section==='chatbot') {
        document.getElementById('chatbot-input').focus();
      }
    }));

    const fetchApi=async u=>{
      try{
        let r=await fetch(u);
        if(!r.ok)throw'';
        return await r.json()
      }catch{
        return null
      }
    };

    async function fetchMeteo(){
      if(!navigator.geolocation){
        document.getElementById('meteo-info').textContent="Geolocalizzazione non supportata";
        return;
      }
      navigator.geolocation.getCurrentPosition(async pos=>{
        let lat=pos.coords.latitude.toFixed(2),lon=pos.coords.longitude.toFixed(2);
        let d=await fetchApi(`/api/meteo?lat=${lat}&lon=${lon}`);
        if(!d?.current_weather){
          document.getElementById('meteo-info').textContent="Errore meteo";
          return;
        }
        let w=d.current_weather,m={0:"Sereno",1:"Parz.nuvoloso",2:"Nuvoloso",3:"Coperto",45:"Nebbia",48:"Nebbia brina",51:"Pioggerella leggera",53:"Pioggerella moderata",55:"Pioggerella intensa",61:"Pioggia leggera",63:"Pioggia moderata",65:"Pioggia intensa",71:"Neve leggera",73:"Neve moderata",75:"Neve intensa",80:"Rovesci leggeri",81:"Rovesci moderati",82:"Rovesci intensi",95:"Temporale",96:"Temp. con grandine leggera",99:"Temp. con grandine intensa"};
        document.getElementById('meteo-info').textContent=`${w.temperature}°C, ${m[w.weathercode]||'Sconosciuto'}, vento ${w.windspeed} km/h`;
        document.getElementById('meteo-timezone').textContent=`Fuso rilevato: ${d.timezone}`;
      },()=>document.getElementById('meteo-info').textContent="Permesso negato");
    }

    let td;
    const fetchNotizie=async(q='tecnologia')=>{
      let info=document.getElementById('news-info'),cont=document.getElementById('news-container');
      info.textContent="Caricamento notizie...";
      cont.innerHTML='';
      let d=await fetchApi(`/api/notizie?q=${encodeURIComponent(q)}`);
      if(!d?.articles?.length){
        info.textContent="Nessuna notizia";
        return;
      }
      info.textContent='';
      d.articles.filter(a=>a.image&&a.description).forEach(a=>{
        let el=document.createElement('div');el.className='news-item';
        el.innerHTML=`<img class="news-image" src="${a.image}" alt=""/><div class="news-content"><div class="news-title">${a.title}</div><div class="news-description">${a.description}</div><div class="news-date">${new Date(a.publishedAt).toLocaleString('it-IT',{dateStyle:'medium',timeStyle:'short'})}</div><div class="news-excerpt">${a.content?.split('[')[0]||''}</div><a class="news-link" href="${a.url}" target="_blank">Leggi di più</a></div>`;
        cont.appendChild(el);
      });
    };

    document.getElementById('news-search').addEventListener('input',e=>{
      clearTimeout(td);
      let q=e.target.value.trim()||'tecnologia';
      td=setTimeout(()=>fetchNotizie(q),500);
    });

    function updateTime(){
      document.getElementById('time-info').textContent=new Date().toLocaleTimeString();
      document.getElementById('ora-timezone').textContent=`Fuso client: ${Intl.DateTimeFormat().resolvedOptions().timeZone}`;
    }

    const fetchEventi=async()=>{
      let ul=document.getElementById('events-list');
      ul.innerHTML='';
      let d=await fetchApi('/api/eventi');
      if(!d?.events?.length){
        ul.innerHTML='<li class="event-item">Nessun evento</li>';
        return;
      }
      d.events.slice(0,5).forEach(ev=>{
        let li=document.createElement('li');li.className='event-item';
        li.innerHTML=`<strong>${ev.name.text}</strong><br>${new Date(ev.start.local).toLocaleDateString('it-IT',{dateStyle:'medium',timeStyle:'short'})}`;
        ul.appendChild(li);
      });
    };

    document.getElementById('contact-form').addEventListener('submit',async e=>{
      e.preventDefault();
      let f=e.target,fd=new FormData(f);
      try{
        let r=await fetch('https://api.web3forms.com/submit',{method:'POST',body:fd});
        let j=await r.json();
        if(j.success){
          Swal.fire({icon:'success',title:'Messaggio inviato!',text:j.message});
          f.reset();
        }
        else{
          Swal.fire({icon:'error',title:'Errore',text:j.message||'Invio fallito'});
        }
      }catch{
        Swal.fire({icon:'error',title:'Errore di rete',text:'Riprova'});
      }
    });

    // CHATBOT
    const chatMessages = document.getElementById('chatbot-messages');
    const chatInput = document.getElementById('chatbot-input');
    const chatSend = document.getElementById('chatbot-send');

    let chatHistory = [];

    function addChatMessage(who, text){
      const div = document.createElement('div');
      div.className = 'chat-message ' + (who === 'user' ? 'user' : 'bot');
      div.textContent = text;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    chatSend.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', e => {
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });

    async function sendMessage(){
      let msg = chatInput.value.trim();
      if(!msg) return;
      addChatMessage('user', msg);
      chatInput.value = '';
      chatHistory.push({role:'user', content: msg});
      addChatMessage('bot', 'Sto scrivendo...');
      try {
        const res = await fetch('/api/chatbot', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({messages: chatHistory})
        });
        const data = await res.json();
        chatMessages.lastChild.textContent = data.reply || data.message || 'Nessuna risposta';
        if(data.reply) chatHistory.push({role:'bot', content: data.reply});
        else if(data.message) chatHistory.push({role:'bot', content: data.message});
      } catch {
        chatMessages.lastChild.textContent = 'Errore nella risposta';
      }
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    fetchMeteo();
    fetchNotizie();
    updateTime();
    setInterval(updateTime,1000);
    fetchEventi();
  }
})();
</script>
</body>
</html>
